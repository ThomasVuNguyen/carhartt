<Window x:Class="Carhartt.App.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:core="clr-namespace:Carhartt.Core;assembly=Carhartt.Core"
        mc:Ignorable="d"
        Title="Carhartt Browser" Height="768" Width="1024">
    <Window.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVis" />
        
        <!-- Tab Content Template -->
        <DataTemplate DataType="{x:Type core:TabViewModel}">
            <ContentControl Content="{Binding View}" />
        </DataTemplate>
    </Window.Resources>
    
    <Window.InputBindings>
        <KeyBinding Key="T" Modifiers="Ctrl" Command="{Binding AddTabCommand}" />
        <KeyBinding Key="W" Modifiers="Ctrl" Command="{Binding CloseTabCommand}" CommandParameter="{Binding SelectedTab}" />
        <!-- Pass F12 to SelectedTab -->
        <KeyBinding Key="F12" Command="{Binding SelectedTab.DevToolsCommand}" />
    </Window.InputBindings>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Menu / Top Bar (Optional, simpler to put Add Tab button here or in TabControl) -->
        
        <!-- Toolbar (Global, Acts on SelectedTab) -->
        <Border Grid.Row="1" Padding="5" Background="#F0F0F0" BorderBrush="#CCCCCC" BorderThickness="0,0,0,1">
            <Grid DataContext="{Binding SelectedTab}">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <Button Grid.Column="0" Command="{Binding BackCommand}" Content="&lt;" Width="30" Margin="0,0,5,0"/>
                <Button Grid.Column="1" Command="{Binding ForwardCommand}" Content="&gt;" Width="30" Margin="0,0,5,0"/>
                <Button Grid.Column="2" Command="{Binding ReloadCommand}" Content="R" Width="30" Margin="0,0,5,0"/>
                <Button Grid.Column="3" Command="{Binding StopCommand}" Content="X" Width="30" Margin="0,0,5,0"/>

                <TextBox Grid.Column="4" Text="{Binding AddressBarUrl, UpdateSourceTrigger=PropertyChanged}" VerticalContentAlignment="Center" Margin="0,0,5,0">
                    <TextBox.InputBindings>
                        <KeyBinding Key="Return" Command="{Binding NavigateCommand}" />
                    </TextBox.InputBindings>
                </TextBox>
                
                <Button Grid.Column="5" Command="{Binding NavigateCommand}" Content="Go" Width="30"/>
            </Grid>
        </Border>

        <!-- Loading Indicator -->
        <ProgressBar Grid.Row="1" VerticalAlignment="Bottom" Height="2" IsIndeterminate="True" 
                     DataContext="{Binding SelectedTab}"
                     Visibility="{Binding IsLoading, Converter={StaticResource BoolToVis}, FallbackValue=Collapsed}" 
                     Background="Transparent" BorderThickness="0"/>

        <!-- Tabs -->
        <TabControl Grid.Row="2" ItemsSource="{Binding Tabs}" SelectedItem="{Binding SelectedTab}" Background="White">
            <TabControl.ItemTemplate>
                <DataTemplate>
                    <StackPanel Orientation="Horizontal">
                        <TextBlock Text="{Binding Title}" MaxWidth="150" TextTrimming="CharacterEllipsis" Margin="0,0,5,0"/>
                        <Button Content="x" Command="{Binding DataContext.CloseTabCommand, RelativeSource={RelativeSource AncestorType=Window}}" 
                                CommandParameter="{Binding}" Width="15" Height="15" FontSize="10" Padding="0"/>
                    </StackPanel>
                </DataTemplate>
            </TabControl.ItemTemplate>
            <!-- ContentTemplate is implicit via DataTemplate DataType above if we remove this, 
                 OR we bind Content to View explicitly. 
                 TabControl automatically uses ItemTemplate for Header and ContentTemplate for Content.
                 However, ItemsSource is TabViewModels.
                 We defined a DataTemplate for TabViewModel in Resources.
                 So we don't need explicit ContentTemplate if TabControl uses the object as content.
            -->
        </TabControl>
        
        <!-- Add Tab Button overlay or separate? 
             Simplest is a button next to TabControl headers, but that requires ControlTemplate hacking.
             For MVP, let's put "New Tab" button in the Toolbar or a menu.
             Actually, let's put it in row 0 above toolbar? 
             Or just rely on CTRL+T. 
             Let's add a small "+" button in Row 0 for visibility.
        -->
        <Button Grid.Row="0" HorizontalAlignment="Left" Content="+ New Tab" Padding="5,2" Margin="5" Command="{Binding AddTabCommand}"/>

        <!-- StatusBar -->
        <StatusBar Grid.Row="3">
            <StatusBarItem>
                <TextBlock Text="Memory: " FontWeight="Bold"/>
            </StatusBarItem>
            <StatusBarItem>
                <TextBlock Text="{Binding MemoryUsageMb}" Width="60"/>
            </StatusBarItem>
            <Separator/>
            <StatusBarItem>
                <TextBlock Text="CPU: " FontWeight="Bold"/>
            </StatusBarItem>
            <StatusBarItem>
                <TextBlock Text="{Binding CpuUsagePercent}" Width="50"/>
            </StatusBarItem>
        </StatusBar>
    </Grid>
</Window>
